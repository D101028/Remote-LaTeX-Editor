<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monaco LaTeX Live Preview</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      display: flex;
      font-family: sans-serif;
    }

    #editor {
      width: 50%;
      height: 100%;
      border-right: 1px solid #ccc;
    }

    #preview {
      width: 50%;
      height: 100%;
      padding: 1em;
      overflow-y: auto;
      background: #fdfdfd;
    }

    .katex-error {
      color: red;
    }
  </style>
</head>
<body>
  <div id="editor"></div>
  <div id="preview">Rendering...</div>

  <!-- Monaco Editor -->
  <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>

  <!-- KaTeX for rendering -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <script>
    require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@latest/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      // 註冊 latex 語言
      monaco.languages.register({ id: 'latex' });

      // 定義 latex 語法高亮
      monaco.languages.setMonarchTokensProvider('latex', {
        tokenizer: {
          root: [
            [/\\[a-zA-Z]+/, "keyword"],        // 指令，如 \frac
            [/%.*$/, "comment"],               // 註解
            [/\$[^$]*\$/, "string"],           // $...$
            [/\\\[/, { token: "string", next: "@mathEnv" }], // \[...\]
            [/{|}/, "delimiter.bracket"],      // 大括號
          ],
          mathEnv: [
            [/\\\]/, { token: "string", next: "@pop" }],
            [/./, "string"]
          ]
        }
      });

      // 建立 Monaco 編輯器
      const editor = monaco.editor.create(document.getElementById('editor'), {
        value: `\\documentclass{article}
\\begin{document}
This is inline math: $E = mc^2$.

Displayed equation:

$$
\\int_0^\\infty e^{-x^2} dx = \\frac{\\sqrt{\\pi}}{2}
$$

% This is a LaTeX comment
\\end{document}
        `,
        language: 'latex',
        theme: 'vs-light',
        fontSize: 16,
        automaticLayout: true
      });

      const previewEl = document.getElementById('preview');

      function renderLatex(content) {
        // 防止 HTML 注入
        previewEl.innerHTML = content
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        renderMathInElement(previewEl, {
          delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "$", right: "$", display: false }
          ],
          throwOnError: false
        });
      }

      // 初次渲染
      renderLatex(editor.getValue());

      // 每次內容變動時即時更新
      editor.onDidChangeModelContent(() => {
        renderLatex(editor.getValue());
      });
    });
  </script>
</body>
</html>
